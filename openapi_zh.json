{"openapi":"3.1.0","info":{"title":"DCMG","version":"0.1.0"},"paths":{"/api/scm/upload_imgzip_with_usb":{"get":{"tags":["SCM"],"summary":"通过USB上传图像压缩包","description":"此函数将图像文件上传到USB驱动器，并返回一个生成器以显示上传进度。

## 参数:

- **image**: 图像文件的名称。

## 返回

- **upload_progress**: 上传进度。","operationId":"upload_imgzip_with_usb_api_scm_upload_imgzip_with_usb_get","parameters":[{"name":"image","in":"query","required":true,"schema":{"type":"string","title":"Image"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/upload_imgzip_chunked":{"post":{"tags":["SCM"],"summary":"分块上传图像压缩包","description":"此函数将上传的图像文件分块，并返回一个生成器以显示上传进度。

## 参数:

- **image**: 包含图像的ZIP文件。示例结构:<br/>
    myzip.zip<br/>
    ├── folder_name/<br/>
    │   ├── 1.jpg<br/>
    │   └── 2.png<br/>

## 返回
- **upload_progress**: 上传进度。","operationId":"upload_imgzip_chunked_api_scm_upload_imgzip_chunked_post","requestBody":{"content":{"multipart/form-data":{"schema":{"$ref":"#/components/schemas/Body_upload_imgzip_chunked_api_scm_upload_imgzip_chunked_post"}}},"required":true},"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/run_job":{"post":{"tags":["SCM"],"summary":"运行任务","description":"此端点用于运行带有图像ZIP文件的任务。

## 参数:

- **images_dir**: 包含图像的目录。<br/>
- **run_id**: 任务的ID。<br/>
- **job_name**: 任务的名称。<br/>
- **gsd_cm**: 地面采样距离（厘米）。<br/>
- **row_spacing_cm**: 行距（厘米）。<br/>
- **plant_spacing_cm**: 植物间距（厘米）。<br/>
- **ridge_spacing_cm**: 垄距（厘米）。<br/>
- **big_threshold**: 图像中大物体的阈值。<br/>
- **small_threshold**: 图像中小物体的阈值。

## 返回

- **job**: 任务的详细信息。","operationId":"run_job_api_scm_run_job_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/JobSettings"}}},"required":true},"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/get_job_details":{"get":{"tags":["SCM"],"summary":"获取任务详情","description":"此端点用于获取任务的详细信息。
任务详情包括输入参数、进度和检测到的图像列表。

## 参数:

- **job_id**: 任务的ID。

## 返回
- **job**: 任务的详细信息。","operationId":"get_job_details_api_scm_get_job_details_get","parameters":[{"name":"job_id","in":"query","required":true,"schema":{"type":"integer","title":"Job Id"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/get_job_logs":{"get":{"tags":["SCM"],"summary":"获取任务日志","description":"此端点用于获取任务的日志。

## 参数:

- **job_id**: 任务的ID。

## 返回
- **logs**: 任务的日志。","operationId":"get_job_logs_api_scm_get_job_logs_get","parameters":[{"name":"job_id","in":"query","required":true,"schema":{"type":"integer","title":"Job Id"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/job_uploaded":{"put":{"tags":["SCM"],"summary":"更新任务状态","description":"此端点用于更新任务的状态。

## 参数:

- **job_id**: 任务的ID。

## 返回
- **success**: 一个布尔值，表示状态是否成功更新。","operationId":"update_job_status_api_scm_job_uploaded_put","parameters":[{"name":"job_id","in":"query","required":true,"schema":{"type":"integer","title":"Job Id"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/get_job_status":{"get":{"tags":["SCM"],"summary":"获取任务状态","description":"此端点用于查询任务的状态。

## 参数:

- **job_id**: 任务的ID。

## 返回
- **is_running**: 一个布尔值，表示任务是否正在运行。","operationId":"get_job_status_api_scm_get_job_status_get","parameters":[{"name":"job_id","in":"query","required":true,"schema":{"type":"integer","title":"Job Id"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{"$ref":"#/components/schemas/JobRunner"}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/get_jobs":{"get":{"tags":["SCM"],"summary":"获取任务列表","description":"此端点用于获取所有任务的列表。

## 参数:

- **page**: 要检索的页码，默认值：1
- **limit**: 每页要检索的任务数，默认值：10
- **status**: 要检索的任务状态，逗号分隔，默认值：None (全部)
  - **waiting**: 任务正在等待处理。
  - **running**: 任务正在运行。
  - **completed**: 任务已完成。
  - **failed**: 任务已失败。
  - **uploaded**: 任务已上传。
- **job_name**: 要检索的任务名称，默认值：None (全部)

## 返回
- **jobs**: 所有任务的列表。","operationId":"get_jobs_api_scm_get_jobs_get","parameters":[{"name":"page","in":"query","required":false,"schema":{"type":"integer","default":1,"title":"Page"}},{"name":"limit","in":"query","required":false,"schema":{"type":"integer","default":10,"title":"Limit"}},{"name":"status","in":"query","required":false,"schema":{"type":"string","title":"Status"}},{"name":"job_name","in":"query","required":false,"schema":{"type":"string","title":"Job Name"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/remove_job_all_res_by_id":{"delete":{"tags":["SCM"],"summary":"根据ID删除任务所有资源","description":"此端点用于删除任务及其所有相关资源（图像、日志等）。

## 参数:

- **job_id**: 任务的ID。

## 返回

- **success**: 一个布尔值，表示任务是否成功删除。","operationId":"remove_job_all_res_by_id_api_scm_remove_job_all_res_by_id_delete","parameters":[{"name":"job_id","in":"query","required":true,"schema":{"type":"integer","title":"Job Id"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/update_job_progress":{"get":{"tags":["SCM"],"summary":"更新任务进度","description":"此端点用于更新任务的进度。

仅由容器回调使用以更新进度。

## 参数:

- **run_id**: 任务的ID。
- **percent**: 任务的进度百分比。

## 返回
- **progress**: 任务的进度。","operationId":"update_job_progress_api_scm_update_job_progress_get","parameters":[{"name":"run_id","in":"query","required":true,"schema":{"type":"string","title":"Run Id"}},{"name":"percent","in":"query","required":true,"schema":{"type":"number","title":"Percent"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/scm/save_report":{"post":{"tags":["SCM"],"summary":"保存报告","description":"此端点用于保存任务的报告。

报告是一个包含检测到的图像及其属性的JSON对象。

仅由容器回调使用以保存报告。","operationId":"save_report_api_scm_save_report_post","requestBody":{"content":{"application/json":{"schema":{"additionalProperties":true,"type":"object","title":"Data"}}},"required":true},"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/get_odm_jobs":{"get":{"tags":["ODM"],"summary":"获取ODM任务","description":"## 获取ODM任务列表
该端点返回ODM任务列表。

### 此端点执行以下操作:
1. 从数据库获取RSDM任务列表
2. 如果`only_running`设置为`True`，则过滤正在运行的任务
3. 返回过滤后的任务列表

### 参数
- **page**: 页码（默认：1）
- **limit**: 每页项目数（默认：1000）
- **only_running**: 仅过滤正在运行的任务（默认：True）

### 状态
- **PENDING**: 任务正在等待处理
- **RUNNING**: 任务正在处理中
- **COMPLETED**: 任务已成功完成
- **FAILED**: 任务已失败
- **CANCELED**: 任务已被用户或系统取消

### 响应
返回`List[OdmJobs]`，包含字段:
- **run_id**: 任务唯一标识符
- **odm_project_id**: 相关项目ID
- **odm_job_name**: 人类可读的任务名称
- **odm_src_folder**: 数据存储路径
- ...其他字段...

### 示例
```json
[{
  \"id\": 1,
  \"odm_project_id\": 1,
  \"odm_job_name\": \"test\",
  \"odm_src_folder\": \"images/\",
  \"odm_samplinge_time\": \"2025-08-17T09:04:40.311000\",
  \"odm_image_count\": 56,
  \"progress\": 0,
  \"celery_task_id\": \"66ac0298-e3c0-4744-ae5c-62567f292ae0\",
  \"update_at\": \"2025-08-17T17:00:41.479989\",
  \"odm_task_id\": \"8671d618-6cd7-40ce-aba4-45e85eab19fb\",
  \"run_id\": \"daccd58c51e94960\",
  \"odm_job_type\": \"multispectral\",
  \"odm_dest_folder\": \"E:\\python\\dcmg\\tmp\\1\\8671d618-6cd7-40ce-aba4-45e85eab19fb\",
  \"odm_host\": \"http://192.168.3.194:7000/\",
  \"odm_create_at\": \"2025-08-17T09:04:40.311000\",
  \"state\": \"PENDING\",
  \"err_msg\": null
}]
```","operationId":"get_odm_jobs_api_odm_get_odm_jobs_get","parameters":[{"name":"page","in":"query","required":false,"schema":{"type":"integer","default":1,"title":"Page"}},{"name":"limit","in":"query","required":false,"schema":{"type":"integer","default":1000,"title":"Limit"}},{"name":"only_running","in":"query","required":false,"schema":{"type":"boolean","default":true,"title":"Only Running"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/create_odm_job":{"post":{"tags":["ODM"],"summary":"创建ODM任务","description":"## 创建ODM任务
创建新的ODM任务并启动图像处理管道。

### 此端点执行以下操作:
1. 扫描指定文件夹中与任务类型匹配的图像
2. 验证是否找到图像；如果没有则删除ODM任务
3. 在数据库中创建新的RSDM任务记录
4. 启动后台任务将图像复制到ODM服务器
5. 返回创建的任务信息

### 参数
- **data (OdmJob)**: ODM任务配置，包括文件夹路径、项目ID、任务ID和任务类型

### 响应:
返回`OdmJobs`，包含字段:
- **run_id**: 任务唯一标识符
- **odm_project_id**: 相关项目ID
- **odm_job_name**: 人类可读的任务名称
- **odm_src_folder**: 数据存储路径
- ...其他字段...

### 示例
```json
{
  \"id\": 1,
  \"odm_project_id\": 1,
  \"odm_job_name\": \"test\",
  \"odm_src_folder\": \"images/\",
  \"odm_samplinge_time\": \"2025-08-17T09:04:40.311000\",
  \"odm_image_count\": 56,
  \"progress\": 0,
  \"celery_task_id\": \"66ac0298-e3c0-4744-ae5c-62567f292ae0\",
  \"update_at\": \"2025-08-17T17:00:41.479989\",
  \"odm_task_id\": \"8671d618-6cd7-40ce-aba4-45e85eab19fb\",
  \"run_id\": \"daccd58c51e94960\",
  \"odm_job_type\": \"multispectral\",
  \"odm_dest_folder\": \"E:\\python\\dcmg\\tmp\\1\\8671d618-6cd7-40ce-aba4-45e85eab19fb\",
  \"odm_host\": \"http://192.168.3.194:7000/\",
  \"odm_create_at\": \"2025-08-17T09:04:40.311000\",
  \"state\": \"PENDING\",
  \"err_msg\": null
}
```

### 异常
HTTPException
- **400**: 任务已存在，不允许重复，请检查odm服务器。
- **404**: 在指定文件夹中未找到图像
- **500**: 创建任务时发生内部服务器错误","operationId":"create_odm_job_api_odm_create_odm_job_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/OdmJob"}}},"required":true},"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/get_odm_state":{"get":{"tags":["ODM"],"summary":"获取ODM状态","description":"## 获取ODM任务的当前状态。

此端点获取ODM任务的当前状态。

### 参数
- **project_id**: ODM任务的项目ID
- **task_id**: ODM任务的任务ID

### 响应:
返回`OdmState`，包含字段:
- **state**: ODM任务的当前状态
- **progress**: ODM任务的进度（0-100）
- **host**: ODM服务器的基本URL
- **error**: 如果任务失败，则为错误消息，否则为null

### 示例
```json
{
  \"state\": \"COMPLETED\",
  \"progress\": 100,
  \"host\": \"http://127.0.0.1:8000\",
  \"error\": null
}
```","operationId":"get_odm_state_api_odm_get_odm_state_get","parameters":[{"name":"project_id","in":"query","required":true,"schema":{"type":"integer","title":"Project Id"}},{"name":"task_id","in":"query","required":true,"schema":{"type":"string","title":"Task Id"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{"$ref":"#/components/schemas/OdmState"}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/cancel_odm_job":{"get":{"tags":["ODM"],"summary":"取消ODM任务","description":"## 取消待处理、运行中或等待中的ODM任务。

此端点通过以下方式尝试取消ODM任务:
1. 使用project_id和task_id在数据库中查找任务
2. 检查任务是否处于可以取消的状态（待处理、运行中或等待中）
3. 启动Celery任务的取消
4. ODM服务器将删除任务
5. 更新数据库中的任务状态为已取消

### 参数
- **project_id**: ODM任务的项目ID
- **task_id**: ODM任务的任务ID

### 响应:
返回`OdmJobs`，包含字段:
- **run_id**: 任务唯一标识符
- **odm_project_id**: 相关项目ID
- **odm_job_name**: 人类可读的任务名称
- **odm_src_folder**: 数据存储路径
- ...其他字段...

### 异常:
- **HTTPException:** 如果未找到任务则引发404错误
- **HTTPException:** 如果任务不处于可以取消的状态（待处理、运行中或等待中）则引发400错误
- **HTTPException:** 如果无法从celery任务或odm服务器删除任务则引发500错误","operationId":"cancel_odm_job_api_odm_cancel_odm_job_get","parameters":[{"name":"project_id","in":"query","required":true,"schema":{"type":"integer","title":"Project Id"}},{"name":"task_id","in":"query","required":true,"schema":{"type":"string","title":"Task Id"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/remove_odm_job":{"get":{"tags":["ODM"],"summary":"删除ODM任务","description":"### 删除已完成、失败或已取消的ODM任务。

此端点通过以下方式尝试删除ODM任务:
1. 使用project_id和task_id在数据库中查找任务
2. 检查任务是否处于可以删除的状态（已完成、失败或已取消）
3. 从数据库中删除任务

### 返回:
- **None:** 如果任务已成功从数据库中删除，则返回204无内容

### 异常:
- **HTTPException:** 如果未找到任务则引发404错误
- **HTTPException:** 如果任务不处于可以删除的状态（已完成、失败或已取消）则引发400错误","operationId":"remove_odm_job_api_odm_remove_odm_job_get","parameters":[{"name":"project_id","in":"query","required":true,"schema":{"type":"integer","title":"Project Id"}},{"name":"task_id","in":"query","required":true,"schema":{"type":"string","title":"Task Id"}}],"responses":{"204":{"description":"成功响应"},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/generate_report":{"post":{"tags":["ODM"],"summary":"生成报告","description":"### 为已完成的ODM任务保存ODM报告。

此端点通过以下方式为已完成的ODM任务保存ODM报告:
1. 使用project_id和task_id在数据库中查找任务
2. 检查任务是否处于可以有报告的状态（已完成）
3. 将报告保存到数据库
4. 更新数据库中的任务状态为已完成

### 参数
- **project_id**: ODM任务的项目ID
- **task_id**: ODM任务的任务ID
- **orthophoto_tif**: 正射影像tif文件的路径

### 返回:
- **None:** 如果报告已成功保存到数据库，则返回204无内容

### 异常:
- **HTTPException:** 如果未提供正射影像tif文件则引发400错误
- **HTTPException:** 如果未找到正射影像tif文件则引发404错误
- **HTTPException:** 如果未找到任务则引发404错误","operationId":"generate_report_api_odm_generate_report_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/OdmGenRep"}}},"required":true},"responses":{"204":{"description":"成功响应"},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/save_report":{"post":{"tags":["ODM"],"summary":"保存报告","description":"## 为已完成的ODM任务保存ODM报告。

此端点通过以下方式为已完成的ODM任务保存ODM报告:
1. 使用project_id和task_id在数据库中查找任务
2. 检查任务是否处于可以有报告的状态（已完成）
3. 将报告保存到数据库
4. 更新数据库中的任务状态为已完成

### 参数
- **data** (OdmAlgoRep): 报告数据包括:
- **project_id** (int): 与此报告关联的项目ID
- **task_id** (str): 与此报告关联的任务ID
- **output_dir** (str): 存储输出文件的目录
- **log_file** (str): 日志文件的路径
- **algo_name** (str): 使用的算法名称（例如，\"ndvi\"）
- **file_name** (str): 正射影像文件的名称
- **area_mu** (float): 面积测量值
- **report** (dict): 包含报告统计数据的字典，包括:
    - 最小值、最大值、平均值、标准差
    - 输出文件列表
    - 分类计数数据

### 返回:
- **OdmReport:** 返回保存的报告对象","operationId":"save_report_api_odm_save_report_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/OdmAlgoRep"}}},"required":true},"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/get_report_detail":{"get":{"tags":["ODM"],"summary":"获取报告详情","description":"## 获取ODM报告的当前状态。

此端点获取ODM报告的当前状态。

### 参数
- **project_id**: ODM任务的项目ID
- **task_id**: ODM任务的任务ID
- **algo_name**: 用于生成报告的算法名称

### 响应:
返回`OdmReport`","operationId":"get_report_detail_api_odm_get_report_detail_get","parameters":[{"name":"project_id","in":"query","required":true,"schema":{"type":"integer","title":"Project Id"}},{"name":"task_id","in":"query","required":true,"schema":{"type":"string","title":"Task Id"}},{"name":"algo_name","in":"query","required":false,"schema":{"type":"string","default":"ndvi","title":"Algo Name"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/get_reports":{"get":{"tags":["ODM"],"summary":"获取报告","description":"## 获取ODM报告列表。

此端点获取ODM报告列表。

### 参数
- **page**: 要检索的页码（默认：1）
- **limit**: 要检索的记录数（默认：1000）
- **only_running**: 是否仅检索仍在运行的报告（默认：True）

### 返回:
- **List[OdmReport]:** 返回OdmReport对象列表","operationId":"get_reports_api_odm_get_reports_get","parameters":[{"name":"page","in":"query","required":false,"schema":{"type":"integer","default":1,"title":"Page"}},{"name":"limit","in":"query","required":false,"schema":{"type":"integer","default":1000,"title":"Limit"}},{"name":"only_running","in":"query","required":false,"schema":{"type":"boolean","default":true,"title":"Only Running"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/upload_report":{"post":{"tags":["ODM"],"summary":"上传报告","description":"## 将ODM报告上传到OSS并提交到在线系统。

此端点将ODM报告上传到OSS并将报告信息提交到在线系统:
1. 使用project_id、task_id和algo_name在数据库中查找报告
2. 准备OSS上传的环境变量
3. 启动后台任务将报告文件上传到OSS
4. 将报告元数据提交到在线系统
5. 更新数据库中的报告状态为运行中

### 参数
- **data** (UploadRepTask): 上传报告任务数据，包括project_id、task_id、algo_name和report_no
- **token** (str, Header): ODM服务器的身份验证令牌
- **cid** (str, Header): ODM服务器的客户端ID
- **db** (Session): 数据库会话依赖

### 返回:
- **OdmReport:** 返回更新后的报告对象，包含新的celery任务ID和运行中状态

### 异常:
- **HTTPException:** 如果未找到报告则引发404错误
- **HTTPException:** 如果报告已上传则引发400错误

### 流程:
1. 查询数据库中指定的ODM报告
2. 如果未找到报告，则引发404错误
3. 准备OSS上传和在线提交的环境变量
4. 启动Celery任务以:
   a. 将报告文件上传到OSS并跟踪进度
   b. 将报告元数据提交到在线系统
5. 使用新的Celery任务ID和运行中状态更新报告记录
6. 将更改提交到数据库
7. 返回更新后的报告对象

### 后台任务步骤:
后台任务执行以下操作:
1. 从ODM服务器下载完整报告ZIP
2. 将单个输出文件上传到OSS
3. 将完整报告ZIP上传到OSS
4. 将报告信息和元数据提交到在线系统
5. 更新数据库的最终状态","operationId":"upload_report_api_odm_upload_report_post","parameters":[{"name":"token","in":"header","required":true,"schema":{"type":"string","title":"Token"}},{"name":"cid","in":"header","required":true,"schema":{"type":"string","title":"Cid"}}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/UploadRepTask"}}}},"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/odm/cancel_upload_task":{"get":{"tags":["ODM"],"summary":"取消上传任务","description":"## 取消ODM报告上传任务。
此端点通过以下方式取消ODM报告上传任务:
1. 使用project_id、task_id和algo_name在数据库中查找报告
2. 检查报告是否正在运行
3. 中止与报告关联的Celery任务
4. 更新数据库中的报告状态为已取消

### 参数
- **project_id**: ODM任务的项目ID
- **task_id**: ODM任务的任务ID
- **algo_name**: 用于生成报告的算法名称
- **db** (Session): 数据库会话依赖

### 返回:
- **None:** 如果报告上传任务已成功取消，则返回204无内容

### 异常:
- **HTTPException:** 如果未找到报告则引发404错误
- **HTTPException:** 如果报告未运行则引发400错误。无法取消。","operationId":"cancel_upload_task_api_odm_cancel_upload_task_get","parameters":[{"name":"project_id","in":"query","required":true,"schema":{"type":"integer","title":"Project Id"}},{"name":"task_id","in":"query","required":true,"schema":{"type":"string","title":"Task Id"}},{"name":"algo_name","in":"query","required":false,"schema":{"type":"string","default":"ndvi","title":"Algo Name"}}],"responses":{"204":{"description":"成功响应"},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/3dcm/jobs":{"post":{"tags":["3DCM"],"summary":"创建3DCM任务","description":"### 创建新的VDCM任务

此端点通过以下方式创建新的VDCM任务:
1. 检查是否存在具有相同ID的任务
2. 验证源文件是否存在
3. 创建输出的目标文件夹
4. 在Celery中启动重建任务
5. 将任务信息保存到数据库

### 参数:
- **data**: 包含任务信息的Vdcm模型，包括任务ID和源路径
- **db**: 数据库会话依赖

### 特殊处理:
- **no**: 如果未提供，将生成唯一ID，格式为PXXXXX_YY_SAMPLEBATCH_SAMPLE，
  其中XXXXX是5位数字，YY是2位数字
- **taken_at**: 如果未提供，将设置为源文件的创建时间

### 返回:
- **VdcmJobs**: 包含所有详细信息的已创建任务对象

### 异常:
- **HTTPException**: 400错误，如果具有相同ID的任务已存在
- **HTTPException**: 400错误，如果源文件不存在","operationId":"create_3dcm_job_api_3dcm_jobs_post","requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/Vdcm"}}}},"responses":{"201":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}},"get":{"tags":["3DCM"],"summary":"获取任务","description":"### 检索VDCM任务

此端点检索VDCM任务列表，支持分页:
1. 查询数据库中的VDCM任务
2. 按ID降序排列结果（最新的在前）
3. 使用偏移量和限制应用分页
4. 可选择过滤仅显示正在运行的任务
5. 如果可用，从Celery任务更新上传进度

### 参数:
- **page**: 分页的页码（默认：1）
- **limit**: 每页的项目数（默认：1000）
- **only_running**: 过滤仅运行任务的标志（默认：True）
- **db**: 数据库会话依赖

### 返回:
- **List[VdcmJobs]**: 符合条件的VDCM任务对象列表

### 上传状态:
- 如果uploads不为null且State为COMPLETED且uploads.cloud_id > 0，
  表示上传已完成，无需再次上传。","operationId":"get_jobs_api_3dcm_jobs_get","parameters":[{"name":"page","in":"query","required":false,"schema":{"type":"integer","default":1,"title":"Page"}},{"name":"limit","in":"query","required":false,"schema":{"type":"integer","default":1000,"title":"Limit"}},{"name":"only_running","in":"query","required":false,"schema":{"type":"boolean","default":true,"title":"Only Running"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/3dcm/jobs/{no}/progress":{"patch":{"tags":["3DCM"],"summary":"更新任务进度","description":"### 更新VDCM任务的进度

此端点通过以下方式更新正在运行的VDCM任务的进度百分比:
1. 使用任务ID在数据库中查找任务
2. 验证任务是否存在
3. 使用提供的百分比更新进度字段
4. 将更改提交到数据库

### 参数:
- **no**: 要更新的任务ID
- **percent**: 任务的进度百分比
- **db**: 数据库会话依赖

### 返回:
- **float**: 更新后的进度值，保留两位小数

### 异常:
- **HTTPException**: 404错误，如果指定ID的任务不存在","operationId":"update_job_progress_api_3dcm_jobs__no__progress_patch","parameters":[{"name":"no","in":"path","required":true,"schema":{"type":"string","title":"No"}},{"name":"percent","in":"query","required":true,"schema":{"type":"number","title":"Percent"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/3dcm/jobs/{no}/cancel":{"post":{"tags":["3DCM"],"summary":"根据编号取消任务","description":"### 取消VDCM任务

此端点通过以下方式取消正在运行的VDCM任务:
1. 使用任务ID在数据库中查找任务
2. 验证任务是否存在
3. 验证任务是否正在运行
4. 取消Celery任务
5. 更新数据库中的任务状态为已取消

### 参数:
- **no**: 要取消的任务ID
- **db**: 数据库会话依赖

### 返回:
- **VdcmJobs**: 包含已取消状态的更新后的任务对象

### 异常:
- **HTTPException**: 404错误，如果指定ID的任务不存在
- **HTTPException**: 400错误，如果任务未运行或待处理","operationId":"cancel_job_by_no_api_3dcm_jobs__no__cancel_post","parameters":[{"name":"no","in":"path","required":true,"schema":{"type":"string","title":"No"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/3dcm/jobs/{no}":{"delete":{"tags":["3DCM"],"summary":"根据编号删除任务","description":"### 完全删除VDCM任务

此端点通过以下方式从系统中完全删除VDCM任务:
1. 使用任务ID在数据库中查找任务
2. 验证任务是否存在
3. 验证任务是否未运行
4. 删除与任务关联的所有文件
5. 从数据库中删除任务记录

### 参数:
- **no**: 要删除的任务ID
- **db**: 数据库会话依赖

### 返回:
- **None**: 成功删除后返回204无内容

### 异常:
- **HTTPException**: 404错误，如果指定ID的任务不存在
- **HTTPException**: 400错误，如果任务仍在运行","operationId":"remove_job_by_no_api_3dcm_jobs__no__delete","parameters":[{"name":"no","in":"path","required":true,"schema":{"type":"string","title":"No"}}],"responses":{"204":{"description":"成功响应"},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/api/3dcm/jobs/{no}/upload":{"post":{"tags":["3DCM"],"summary":"上传报告","description":"### 为已完成的VDCM任务启动报告上传过程

此端点通过以下方式启动已完成VDCM任务的报告上传过程:
1. 验证任务是否存在且已完成
2. 创建或重用现有上传记录
3. 在Celery中启动上传任务
4. 如适用，重置上传相关字段以重新上传

### 参数:
- **no**: 要上传报告的任务ID
- **token**: API请求的身份验证令牌
- **cid**: API请求的客户端ID
- **terminal_id**: API请求的终端ID
- **terminal_type**: API请求的终端类型
- **db**: 数据库会话依赖

### 返回:
- **VdcmUploads**: 包含初始状态的上传任务对象

### 异常:
- **HTTPException**: 404错误，如果任务不存在
- **HTTPException**: 400错误，如果任务未完成
- **HTTPException**: 400错误，如果上传已在进行中","operationId":"upload_report_api_3dcm_jobs__no__upload_post","parameters":[{"name":"no","in":"path","required":true,"schema":{"type":"string","title":"No"}},{"name":"token","in":"header","required":true,"schema":{"type":"string","title":"Token"}},{"name":"cid","in":"header","required":true,"schema":{"type":"string","title":"Cid"}},{"name":"terminal-id","in":"header","required":true,"schema":{"type":"string","title":"Terminal-Id"}},{"name":"terminal-type","in":"header","required":true,"schema":{"type":"string","title":"Terminal-Type"}}],"responses":{"200":{"description":"成功响应","content":{"application/json":{"schema":{}}}},"422":{"description":"验证错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}}},"components":{"schemas":{"Body_upload_imgzip_chunked_api_scm_upload_imgzip_chunked_post":{"properties":{"image":{"type":"string","format":"binary","title":"Image"}},"type":"object","required":["image"],"title":"Body_upload_imgzip_chunked_api_scm_upload_imgzip_chunked_post"},"HTTPValidationError":{"properties":{"detail":{"items":{"$ref":"#/components/schemas/ValidationError"},"type":"array","title":"Detail"}},"type":"object","title":"HTTPValidationError"},"JobRunner":{"properties":{"status":{"$ref":"#/components/schemas/JobStatus"},"progress":{"type":"number","title":"Progress"},"run_id":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Run Id"}},"type":"object","required":["status","progress"],"title":"JobRunner","description":"任务运行器的状态。"},"JobSettings":{"properties":{"images_dir":{"type":"string","title":"Images Dir"},"run_id":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Run Id"},"job_name":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Job Name"},"gsd_cm":{"type":"number","title":"Gsd Cm","default":0.32},"row_spacing_cm":{"type":"number","title":"Row Spacing Cm","default":80.0},"plant_spacing_cm":{"type":"number","title":"Plant Spacing Cm","default":10.0},"ridge_spacing_cm":{"anyOf":[{"type":"number"},{"type":"null"}],"title":"Ridge Spacing Cm"},"big_threshold":{"type":"number","title":"Big Threshold","default":0.2},"small_threshold":{"type":"number","title":"Small Threshold","default":0.3}},"type":"object","required":["images_dir"],"title":"JobSettings","description":"任务的设置。"},"JobStatus":{"type":"string","enum":["waiting","running","completed","failed","uploaded"],"title":"JobStatus"},"JobType":{"type":"string","enum":["VIDEO","IMAGE"],"title":"JobType","description":"任务类型的枚举"},"OdmAlgoRep":{"properties":{"project_id":{"type":"integer","title":"Project Id"},"task_id":{"type":"string","title":"Task Id"},"output_dir":{"type":"string","title":"Output Dir"},"log_file":{"type":"string","title":"Log File"},"algo_name":{"type":"string","title":"Algo Name"},"file_name":{"type":"string","title":"File Name"},"area_mu":{"type":"number","title":"Area Mu"},"report":{"additionalProperties":true,"type":"object","title":"Report"}},"type":"object","required":["project_id","task_id","output_dir","log_file","algo_name","file_name","area_mu","report"],"title":"OdmAlgoRep","description":"ODM算法报告的模型。"},"OdmGenRep":{"properties":{"project_id":{"type":"integer","title":"Project Id"},"task_id":{"type":"string","title":"Task Id"},"orthophoto_tif":{"type":"string","title":"Orthophoto Tif","default":"odm_orthophoto/odm_orthophoto.tif"}},"type":"object","required":["project_id","task_id"],"title":"OdmGenRep","description":"ODM通用报告的模型。"},"OdmJob":{"properties":{"odm_project_id":{"type":"integer","title":"Odm Project Id"},"odm_task_id":{"type":"string","title":"Odm Task Id"},"odm_job_name":{"type":"string","title":"Odm Job Name"},"odm_job_type":{"$ref":"#/components/schemas/OdmType"},"odm_src_folder":{"type":"string","title":"Odm Src Folder"},"odm_samplinge_time":{"type":"string","format":"date-time","title":"Odm Samplinge Time"},"odm_host":{"type":"string","title":"Odm Host"},"odm_create_at":{"type":"string","format":"date-time","title":"Odm Create At"}},"type":"object","required":["odm_project_id","odm_task_id","odm_job_name","odm_job_type","odm_src_folder","odm_samplinge_time","odm_host","odm_create_at"],"title":"OdmJob","description":"表示ODM任务配置和元数据的数据模型。

此模型包含创建和管理ODM（OpenDroneMap）处理任务所需的所有信息。"},"OdmState":{"properties":{"state":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"State"},"progress":{"anyOf":[{"type":"number"},{"type":"null"}],"title":"Progress","default":0.0},"error":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Error"},"host":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Host"}},"type":"object","title":"OdmState"},"OdmType":{"type":"string","enum":["multispectral","rgb"],"title":"OdmType","description":"支持的ODM图像类型的枚举。"},"UploadRepTask":{"properties":{"project_id":{"type":"integer","title":"Project Id"},"task_id":{"type":"string","title":"Task Id"},"report_no":{"type":"string","title":"Report No"},"algo_name":{"type":"string","title":"Algo Name","default":"ndvi"}},"type":"object","required":["project_id","task_id","report_no"],"title":"UploadRepTask","description":"ODM上传报告任务的模型。"},"ValidationError":{"properties":{"loc":{"items":{"anyOf":[{"type":"string"},{"type":"integer"}]},"type":"array","title":"Location"},"msg":{"type":"string","title":"Message"},"type":{"type":"string","title":"Error Type"}},"type":"object","required":["loc","msg","type"],"title":"ValidationError"},"Vdcm":{"properties":{"no":{"type":"string","maxLength":32,"minLength":1,"title":"No","description":"唯一记录标识符"},"title":{"type":"string","maxLength":255,"minLength":1,"title":"Title","description":"任务标题"},"job_type":{"$ref":"#/components/schemas/JobType","description":"任务类型 - VIDEO或IMAGE"},"src_path":{"type":"string","maxLength":255,"minLength":1,"title":"Src Path","description":"媒体文件的源路径"},"frame_count":{"type":"integer","minimum":150.0,"title":"Frame Count","description":"媒体文件中的帧数","default":150},"sample_number":{"type":"string","maxLength":16,"minLength":1,"title":"Sample Number","description":"样本编号标识符"},"sample_batch_number":{"type":"string","maxLength":16,"minLength":1,"title":"Sample Batch Number","description":"样本组的批次号"},"taken_at":{"type":"string","format":"date","title":"Taken At","description":"媒体捕获的时间戳"}},"type":"object","required":["job_type","src_path","sample_number","sample_batch_number"],"title":"Vdcm","description":"VDCM数据模型，用于处理视频/图像元数据"}}}}